<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turnier-Verwaltung</title>
    <link rel="stylesheet" href="turnier-style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üèê Turnier-Verwaltung</h1>
            <nav class="nav-buttons">
                <button onclick="window.location.href='../admin.html'" class="btn btn-secondary">‚Üê Admin Dashboard</button>
                <button onclick="window.location.href='bracket.html'" class="btn btn-info">üìä Turnierbaum (Karten)</button>
                <button onclick="window.location.href='bracket-tree.html'" class="btn btn-info">üå≥ Turnierbaum (Baum)</button>
                <button onclick="window.location.href='schiedsrichter.html'" class="btn btn-info">üì± Schiedsrichter-Ansicht</button>
            </nav>
        </header>

        <!-- Tournament Selection -->
        <section class="card" id="turnier-auswahl">
            <h2>Turnier ausw√§hlen</h2>
            <div class="turnier-select-row">
                <select id="turnier-select" onchange="loadTurnier()">
                    <option value="">-- Turnier w√§hlen --</option>
                </select>
                <button class="btn btn-primary" onclick="showNewTurnierModal()">+ Neues Turnier</button>
            </div>
        </section>

        <!-- Tournament Details (hidden until selected) -->
        <div id="turnier-details" style="display: none;">
            <!-- Tab Navigation -->
            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="config" onclick="switchAdminTab('config')">‚öôÔ∏è Konfiguration</button>
                <button class="tab-btn" data-tab="teams" onclick="switchAdminTab('teams')">üë• Teams & Platzierung</button>
                <button class="tab-btn" data-tab="games" onclick="switchAdminTab('games')">üéÆ Spiele & Steuerung</button>
            </div>

            <!-- Tab 1: Configuration -->
            <div id="tab-config" class="tab-content active">
                <!-- Config Section -->
                <section class="card">
                    <h2>üìã Turnier-Konfiguration</h2>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Turniername</label>
                            <input type="text" id="config-name" placeholder="z.B. BVT 37">
                        </div>
                        <div class="config-item">
                            <label>Startdatum</label>
                            <input type="date" id="config-datum">
                        </div>
                        <div class="config-item">
                            <label>Enddatum (optional, f√ºr mehrt√§gig)</label>
                            <input type="date" id="config-datum-ende">
                        </div>
                        <div class="config-item">
                            <label>Anzahl Teams</label>
                            <input type="number" id="config-teams" min="4" max="128" value="32">
                        </div>
                        <div class="config-item">
                            <label>Anzahl Felder</label>
                            <input type="number" id="config-felder" min="1" max="20" value="4">
                        </div>
                        <div class="config-item">
                            <label>Spielzeit (Min) - optional</label>
                            <input type="number" id="config-spielzeit" min="0" max="60" value="0">
                        </div>
                        <div class="config-item">
                            <label>Pause (Min) - optional</label>
                            <input type="number" id="config-pause" min="0" max="30" value="0">
                        </div>
                        <div class="config-item">
                            <label>Startzeit</label>
                            <input type="time" id="config-startzeit" value="09:00">
                        </div>
                        <div class="config-item">
                            <label>Endzeit</label>
                            <input type="time" id="config-endzeit" value="18:00">
                        </div>
                        <div class="config-item">
                            <label>Modus</label>
                            <select id="config-modus" onchange="updateModusHelp()">
                                <option value="seeded">Gesetzt (Lost√∂pfe) - Bracket</option>
                                <option value="random">Zuf√§llig - Bracket</option>
                                <option value="swiss">Swiss System (Standard)</option>
                                <option value="swiss_144">Swiss System 144 Teams (32 Quali + 128 Main)</option>
                            </select>
                            <small id="modus-help" class="help-text"></small>
                        </div>
                        <div class="config-item">
                            <label>E-Mail Benachrichtigung</label>
                            <input type="checkbox" id="config-email" checked>
                        </div>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="saveConfig()">üíæ Speichern</button>
                        <button class="btn btn-info" onclick="showEmailPreviewModal()">üìß E-Mail Vorschau</button>
                    </div>
                </section>
            </div>

            <!-- Tab 2: Teams & Placement -->
            <div id="tab-teams" class="tab-content">
                <!-- Referee Teams Section -->
                <section class="card">
                    <h2>üë®‚Äç‚öñÔ∏è Schiedsrichter-Teams</h2>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="showAddSchiriModal()">+ Schiedsrichter-Team hinzuf√ºgen</button>
                    </div>
                    <div class="table-container">
                        <table id="schiri-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Team Name</th>
                                    <th>Ansprechpartner</th>
                                    <th>Telefon</th>
                                    <th>Verf√ºgbar</th>
                                    <th>Aktiv</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <!-- Teams Section -->
                <section class="card">
                    <h2>üë• Teams</h2>
                    <div class="team-stats">
                        <span>Gesamt: <strong id="team-count">0</strong></span>
                        <span>Angemeldet: <strong id="team-angemeldet">0</strong></span>
                        <span>Best√§tigt: <strong id="team-bestaetigt">0</strong></span>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="showAddTeamModal()">+ Team hinzuf√ºgen</button>
                        <button class="btn btn-secondary" onclick="showImportTeamsModal()">üì• Teams importieren</button>
                    </div>
                    <div class="filter-row">
                        <input type="text" id="team-search" placeholder="Team suchen..." oninput="filterTeams()">
                        <select id="team-filter-klasse" onchange="filterTeams()">
                            <option value="">Alle Klassen</option>
                            <option value="A">Klasse A</option>
                            <option value="B">Klasse B</option>
                            <option value="C">Klasse C</option>
                            <option value="D">Klasse D</option>
                            <option value="E">Klasse E</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table id="teams-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Team</th>
                                    <th>Ansprechpartner</th>
                                    <th>E-Mail</th>
                                    <th>Verein</th>
                                    <th>Klasse</th>
                                    <th>Setzpos.</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <!-- Ranking Section -->
                <section class="card">
                    <h2>üèÜ Platzierung</h2>
                    <div class="filter-row">
                        <select id="platzierung-runde" onchange="loadPlatzierung()">
                            <option value="">Runde w√§hlen</option>
                            <option value="1">Nach Runde 1</option>
                            <option value="2">Nach Runde 2</option>
                            <option value="3">Nach Runde 3</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadEndplatzierung()">Endplatzierung anzeigen</button>
                    </div>
                    <div class="table-container">
                        <table id="platzierung-table">
                            <thead>
                                <tr>
                                    <th>Platz</th>
                                    <th>Team</th>
                                    <th>Verein</th>
                                    <th>Siege</th>
                                    <th>Niederlagen</th>
                                    <th>Punkte +</th>
                                    <th>Punkte -</th>
                                    <th>Differenz</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Tab 3: Games & Control -->
            <div id="tab-games" class="tab-content">
                <!-- Games Control Section -->
                <section class="card">
                    <h2>üéÆ Turnier-Steuerung</h2>
                    <div class="control-buttons">
                        <button class="btn btn-success btn-large" onclick="startTurnier()" title="Turnier starten: Erstellt automatisch alle Spiele basierend auf dem gew√§hlten Modus (Bracket oder Swiss System)">‚ñ∂Ô∏è Turnier starten</button>
                        <button class="btn btn-primary" onclick="autoAssignFields()" title="Felder zuweisen: Weist automatisch allen wartenden Spielen (status='geplant') ein freies Feld zu. N√ºtzlich wenn Spiele manuell erstellt wurden.">üìç Felder zuweisen</button>
                        <button class="btn btn-primary" onclick="calculateRanking()" title="Platzierung berechnen: Berechnet die Zwischenplatzierung nach einer bestimmten Runde basierend auf Siegen und Punktdifferenz">üìä Platzierung berechnen</button>
                        <button class="btn btn-primary" onclick="calculateFinalRanking()" title="Endplatzierung: Berechnet die finale Platzierung aller Teams nach Abschluss des Turniers">üèÜ Endplatzierung</button>
                        <button class="btn btn-danger" onclick="resetTurnier()" title="Reset: L√∂scht ALLE Spiele und Ergebnisse des Turniers. Teams bleiben erhalten. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!">üîÑ Reset</button>
                    </div>
                </section>

                <!-- Games Overview Section -->
                <section class="card">
                    <h2>üéØ Spiele-√úbersicht</h2>
                    
                    <!-- Active Games on Fields -->
                    <div class="games-section">
                        <h3 class="section-title">üèê Aktive Spiele auf Feldern</h3>
                        <div class="games-grid" id="active-games-container">
                            <p class="empty-state">Keine aktiven Spiele auf Feldern</p>
                        </div>
                    </div>

                    <!-- Vorschau: Next 10 upcoming games -->
                    <div class="games-section">
                        <h3 class="section-title">üëÅÔ∏è Vorschau - N√§chste 10 Spiele</h3>
                        <div class="games-grid" id="vorschau-games-container">
                            <p class="empty-state">Keine Vorschau-Spiele verf√ºgbar</p>
                        </div>
                    </div>

                    <!-- Pending Games (without field, waiting for teams) -->
                    <div class="games-section">
                        <h3 class="section-title collapsible" onclick="togglePending()">
                            <span id="pending-toggle-icon">‚ñ∂</span> ‚è≥ Wartende Spiele (noch ohne Team)
                        </h3>
                        <div class="games-grid collapsed" id="pending-games-container">
                            <p class="empty-state">Keine wartenden Spiele</p>
                        </div>
                    </div>

                    <!-- Completed Games History (collapsible) -->
                    <div class="games-section">
                        <h3 class="section-title collapsible" onclick="toggleHistory()">
                            <span id="history-toggle-icon">‚ñ∂</span> üìú Abgeschlossene Spiele (Historie)
                        </h3>
                        <div class="games-grid collapsed" id="history-games-container">
                            <p class="empty-state">Keine abgeschlossenen Spiele</p>
                        </div>
                    </div>
                </section>

                <!-- Detailed Games Table Section -->
                <section class="card">
                    <h2>üìã Alle Spiele (Detailansicht)</h2>
                    <div class="filter-row">
                        <select id="spiele-filter-phase" onchange="loadSpiele()">
                            <option value="">Alle Phasen</option>
                        </select>
                        <select id="spiele-filter-status" onchange="loadSpiele()">
                            <option value="">Alle Status</option>
                            <option value="geplant">Geplant</option>
                            <option value="bereit">Bereit</option>
                            <option value="laeuft">L√§uft</option>
                            <option value="beendet">Beendet</option>
                            <option value="wartend_bestaetigung">Warten auf Best√§tigung</option>
                            <option value="wartend">Wartend (kein Feld)</option>
                        </select>
                        <input type="text" id="spiele-search" placeholder="Team suchen..." oninput="filterSpiele()">
                    </div>
                    <div class="table-container">
                        <table id="spiele-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Phase</th>
                                    <th>Runde</th>
                                    <th>Team 1</th>
                                    <th>vs</th>
                                    <th>Team 2</th>
                                    <th>Feld</th>
                                    <th>Zeit</th>
                                    <th>Ergebnis</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <!-- Pending Results Section -->
                <section class="card">
                    <h2>üìù Gemeldete Ergebnisse</h2>
                    <div id="meldungen-container">
                        <p>Keine offenen Meldungen</p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- New Tournament Modal -->
    <div class="modal-overlay" id="new-turnier-modal">
        <div class="modal">
            <h3>Neues Turnier erstellen</h3>
            <div class="form-group">
                <label>Turniername</label>
                <input type="text" id="new-turnier-name" placeholder="z.B. BVT 37">
            </div>
            <div class="form-group">
                <label>Datum</label>
                <input type="date" id="new-turnier-datum">
            </div>
            <div class="form-group">
                <label>Anzahl Teams</label>
                <input type="number" id="new-turnier-teams" value="32" min="4" max="128">
            </div>
            <div class="form-group">
                <label>Anzahl Felder</label>
                <input type="number" id="new-turnier-felder" value="4" min="1" max="20">
            </div>
            <div class="form-group">
                <label>Modus</label>
                <select id="new-turnier-modus">
                    <option value="seeded">Gesetzt (Lost√∂pfe) - Bracket</option>
                    <option value="random">Zuf√§llig - Bracket</option>
                    <option value="swiss">Swiss System (Standard)</option>
                    <option value="swiss_144">Swiss System 144 Teams (32 Quali + 128 Main)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="createTurnier()">Erstellen</button>
                <button class="btn btn-secondary" onclick="closeModal('new-turnier-modal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Add Schiedsrichter Team Modal -->
    <div class="modal-overlay" id="add-schiri-modal">
        <div class="modal">
            <h3>Schiedsrichter-Team hinzuf√ºgen</h3>
            <div class="form-group">
                <label>Team Name *</label>
                <input type="text" id="schiri-name" required>
            </div>
            <div class="form-group">
                <label>Ansprechpartner</label>
                <input type="text" id="schiri-ansprechpartner">
            </div>
            <div class="form-group">
                <label>Telefon</label>
                <input type="tel" id="schiri-telefon">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="addSchiri()">Hinzuf√ºgen</button>
                <button class="btn btn-secondary" onclick="closeModal('add-schiri-modal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Add Team Modal -->
    <div class="modal-overlay" id="add-team-modal">
        <div class="modal">
            <h3>Team hinzuf√ºgen</h3>
            <div class="form-group">
                <label>Teamname *</label>
                <input type="text" id="team-name" required>
            </div>
            <div class="form-group">
                <label>Ansprechpartner</label>
                <input type="text" id="team-ansprechpartner">
            </div>
            <div class="form-group">
                <label>E-Mail</label>
                <input type="email" id="team-email">
            </div>
            <div class="form-group">
                <label>Telefon</label>
                <input type="tel" id="team-telefon">
            </div>
            <div class="form-group">
                <label>Verein</label>
                <input type="text" id="team-verein">
            </div>
            <div class="form-group">
                <label>Klasse</label>
                <select id="team-klasse">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                </select>
            </div>
            <div class="form-group">
                <label>Setzposition</label>
                <input type="number" id="team-setzposition" value="0" min="0">
            </div>
            <div class="form-group">
                <label>Passwort / Best√§tigungscode</label>
                <input type="password" id="team-passwort" placeholder="Optionales Passwort">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="addTeam()">Hinzuf√ºgen</button>
                <button class="btn btn-secondary" onclick="closeModal('add-team-modal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Import Teams Modal -->
    <div class="modal-overlay" id="import-teams-modal">
        <div class="modal modal-large">
            <h3>Teams importieren</h3>
            <p>F√ºge die Teams im CSV-Format ein (eine Zeile pro Team):</p>
            <p class="hint">Format: Teamname;Ansprechpartner;Email;Telefon;Verein;Klasse;Setzposition;Passwort</p>
            <textarea id="import-teams-data" rows="10" placeholder="Team 1;Max Mustermann;max@email.de;0123456;TV Musterstadt;A;1;geheim123
Team 2;Anna Schmidt;anna@email.de;0234567;SV Beispiel;A;2;passwort456"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="importTeams()">Importieren</button>
                <button class="btn btn-secondary" onclick="closeModal('import-teams-modal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Edit Result Modal -->
    <div class="modal-overlay" id="edit-result-modal">
        <div class="modal">
            <h3>Ergebnis bearbeiten</h3>
            <input type="hidden" id="edit-spiel-id">
            <div class="result-teams">
                <span id="edit-team1-name">Team 1</span>
                <span>vs</span>
                <span id="edit-team2-name">Team 2</span>
            </div>
            <div class="result-inputs">
                <div class="form-group">
                    <label>Satz Team 1</label>
                    <input type="number" id="edit-ergebnis-team1" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Satz Team 2</label>
                    <input type="number" id="edit-ergebnis-team2" min="0" value="0">
                </div>
            </div>
            <h4>Punkte pro Satz</h4>
            <div class="satz-inputs">
                <div class="satz-row">
                    <span>Punkte Satz 1:</span>
                    <input type="number" id="edit-satz1-team1" min="0" class="satz-input">
                    <span>:</span>
                    <input type="number" id="edit-satz1-team2" min="0" class="satz-input">
                </div>
                <div class="satz-row">
                    <span>Punkte Satz 2:</span>
                    <input type="number" id="edit-satz2-team1" min="0" class="satz-input">
                    <span>:</span>
                    <input type="number" id="edit-satz2-team2" min="0" class="satz-input">
                </div>
                <div class="satz-row">
                    <span>Punkte Satz 3:</span>
                    <input type="number" id="edit-satz3-team1" min="0" class="satz-input">
                    <span>:</span>
                    <input type="number" id="edit-satz3-team2" min="0" class="satz-input">
                </div>
            </div>
            <div class="form-group">
                <label>Bemerkung</label>
                <input type="text" id="edit-bemerkung" placeholder="Optional">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveResult()">Speichern</button>
                <button class="btn btn-secondary" onclick="closeModal('edit-result-modal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div class="modal-overlay" id="email-preview-modal">
        <div class="modal modal-large">
            <h3>üìß E-Mail Vorschau</h3>
            <div class="form-group">
                <label>E-Mail Typ</label>
                <select id="email-preview-type" onchange="updateEmailPreview()">
                    <option value="spielankuendigung">Spielank√ºndigung</option>
                    <option value="ergebnis">Ergebnis-Benachrichtigung</option>
                    <option value="platzierung">Platzierung</option>
                </select>
            </div>
            <div class="form-group">
                <label>Vorschau Betreff</label>
                <input type="text" id="email-preview-subject" readonly>
            </div>
            <div class="form-group">
                <label>Vorschau Inhalt</label>
                <div id="email-preview-content" style="background: var(--light); padding: 15px; border-radius: 8px; min-height: 200px; border: 1px solid var(--border);"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('email-preview-modal')">Schlie√üen</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="turnier-admin.js"></script>
</body>
</html>
