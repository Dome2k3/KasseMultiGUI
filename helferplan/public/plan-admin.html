<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Zeitblöcke verwalten</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    html, body {
      overflow-x: hidden;
    }

    .plan-main {
      max-width: 1200px;
      margin: 0 auto;
    }

    .plan-layout {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .left-panel {
      width: 240px;
      flex: 0 0 240px;
    }

    #plan-container {
      overflow-x: auto;
      flex: 1 1 auto;
      position: relative;
    }

    #timeline-header {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 10;
      display: block;
    }

    .hour-slot {
      font-size: 12px;
      padding: 4px 6px;
      text-align: center;
      background: #fafafa;
    }

    .shift-slot {
      font-size: 12px;
      padding: 6px;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.08s, outline 0.08s;
    }

    .shift-slot.allowed {
      background-color: #cce5ff;
      border: 1px solid #004085;
    }

    .shift-slot.not-allowed {
      background-color: #f4f4f4;
      border: 1px dashed #aaa;
    }

    .shift-slot.hover {
      outline: 3px dashed #007bff;
    }

    .activity-name {
      padding: 8px;
      background: #fff;
      border-right: 1px solid #e6e6e6;
      font-weight: 600;
      text-align: center;
    }

    .activity-row {
      display: grid;
      grid-template-columns: 240px auto;
      align-items: center;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
<nav>
  <a href="index.html" class="active">Admin: Stammdaten</a>
  <a href="plan.html">Turnier-Planung</a>
  <a href="plan-admin.html">Turnier-Admin</a>
</nav>

<main class="plan-main">
  <h1>Admin: Zeitblöcke verwalten</h1>
  <div class="plan-layout">
    <div class="left-panel">
      <h3>Aktivitäten</h3>
      <div id="activity-list"></div>
    </div>

    <div id="plan-container">
      <div id="timeline-header" aria-hidden="true"></div>
      <div id="grid-container" role="grid"></div>
    </div>
  </div>
</main>
<script src="/helferplan/public/config.js"></script>
<script>
  const API_URL_HELFERPLAN = (() => {
    const meta = document.querySelector('meta[name="api-url-helferplan"]');
    if (meta && meta.content) return meta.content.replace(/\/$/, '');
    if (window.__API_URL_HELFERPLAN) return String(window.__API_URL_HELFERPLAN).replace(/\/$/, '');
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      return `${window.location.protocol}//${window.location.hostname}:3003/api`;
    }
    return `${window.location.origin}/api`;
  })();

  document.addEventListener('DOMContentLoaded', async () => {
    const timelineHeader = document.getElementById('timeline-header');
    const gridContainer = document.getElementById('grid-container');

    let activities = [];
    let allowedBlocks = {};

    async function fetchActivities() {
      const res = await fetch(`${API_URL_HELFERPLAN}/activities`);
      activities = await res.json();
    }

    async function fetchAllowedBlocks() {
      for (const activity of activities) {
        const res = await fetch(`${API_URL_HELFERPLAN}/activities/${activity.id}/allowed-time-blocks`);
        allowedBlocks[activity.id] = await res.json();
      }
    }

    function renderTimeline() {
      timelineHeader.innerHTML = '';
      for (let hour = 0; hour < 48; hour++) {
        const hourSlot = document.createElement('div');
        hourSlot.className = 'hour-slot';
        hourSlot.textContent = `${12 + (hour % 24)}:00`;
        timelineHeader.appendChild(hourSlot);
      }
    }

    function renderGrid() {
      gridContainer.innerHTML = '';
      activities.forEach(activity => {
        const row = document.createElement('div');
        row.className = 'activity-row';

        const nameCell = document.createElement('div');
        nameCell.className = 'activity-name';
        nameCell.textContent = activity.name;
        row.appendChild(nameCell);

        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = `repeat(48, 40px)`;

        for (let hour = 0; hour < 48; hour++) {
          const slot = document.createElement('div');
          slot.className = 'shift-slot';

          const isAllowed = allowedBlocks[activity.id]?.some(block => hour >= block.start && hour < block.end);
          slot.classList.add(isAllowed ? 'allowed' : 'not-allowed');

          slot.draggable = true;
          slot.addEventListener('dragstart', () => {
            slot.classList.add('hover');
          });
          slot.addEventListener('dragend', () => {
            slot.classList.remove('hover');
          });
          slot.addEventListener('drop', async (event) => {
            event.preventDefault();
            const updatedBlocks = allowedBlocks[activity.id] || [];
            const existingIndex = updatedBlocks.findIndex(block => hour >= block.start && hour < block.end);
            if (existingIndex >= 0) {
              updatedBlocks.splice(existingIndex, 1);
              slot.classList.remove('allowed');
              slot.classList.add('not-allowed');
            } else {
              updatedBlocks.push({ start: hour, end: hour + 1 });
              slot.classList.remove('not-allowed');
              slot.classList.add('allowed');
            }
            await fetch(`${API_URL_HELFERPLAN}/activities/${activity.id}/allowed-time-blocks`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ blocks: updatedBlocks })
            });
            allowedBlocks[activity.id] = updatedBlocks;
          });

          grid.appendChild(slot);
        }

        row.appendChild(grid);
        gridContainer.appendChild(row);
      });
    }

    await fetchActivities();
    await fetchAllowedBlocks();
    renderTimeline();
    renderGrid();
  });
</script>
</body>
</html>