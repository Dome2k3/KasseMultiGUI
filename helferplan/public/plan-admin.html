<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Zeitblöcke verwalten</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-main { max-width: 1200px; margin: 0 auto; }
    .admin-layout { display: flex; gap: 12px; align-items: flex-start; }
    .left-panel { width: 240px; flex: 0 0 240px; }
    .shift-slot { cursor: pointer; }

    /* Farben für Blöcke */
    .shift-slot.not-allowed { background-color: #f4f4f4; color: #aaa; }
    .shift-slot.allowed { background-color: #cce5ff; color: #004085; }
    .shift-slot.existing { background-color: #ffeeba; color: #856404; }
  </style>
</head>
<body>
<nav>
  <a href="index.html" class="active">Admin: Stammdaten</a>
  <a href="plan.html">Turnier-Planung</a>
  <a href="plan-admin.html">Turnier-Admin</a>
</nav>

<main class="admin-main">
  <h1>Admin: Zeitblöcke verwalten</h1>

  <div id="admin-layout" class="admin-layout">
    <div class="left-panel">
      <h3>Aktivitäten</h3>
      <!-- Liste der Aktivitäten -->
      <ul id="activity-list"></ul>
    </div>

    <div id="plan-container">
      <!-- Zeitplan -->
      <div id="timeline-header" aria-hidden="true"></div>
      <div id="grid-container" role="grid"></div>
    </div>
  </div>
</main>
<script src="/helferplan/public/config.js"></script>
<script>
  // API-Basis-URL (automatisch ermittelt)
  const API_URL = (() => {
    const meta = document.querySelector('meta[name="api-url-helferplan"]');
    if (meta && meta.content) return meta.content.replace(/\/$/, '');
    if (window.__API_URL_HELFERPLAN) return String(window.__API_URL_HELFERPLAN).replace(/\/$/, '');
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      return `${window.location.protocol}//${window.location.hostname}:3003/api`;
    }
    return `${window.location.origin}/api`;
  })();

  // expose for debugging / other scripts
  window.API_URL = API_URL;
  console.info('API_URL =', API_URL);

  let selectedActivity = null;

  // Lädt die Liste der Aktivitäten
  async function loadActivities() {
    const res = await fetch(`${API_URL_HELFERPLAN}/activities`);
    const activities = await res.json();
    const list = document.getElementById('activity-list');
    list.innerHTML = '';
    activities.forEach(activity => {
      const li = document.createElement('li');
      li.textContent = activity.name;
      li.style.cursor = 'pointer';
      li.addEventListener('click', () => {
        selectedActivity = activity;
        renderGrid(activity);
      });
      list.appendChild(li);
    });
  }

  // Rendert das Zeitraster für eine Aktivität
  async function renderGrid(activity) {
    const res = await fetch(`${API_URL_HELFERPLAN}/activities/${activity.id}/allowed-time-blocks`);
    const allowedBlocks = await res.json();

    // Lade bestehende Schichten
    const shiftsRes = await fetch(`${API_URL_HELFERPLAN}/tournament-shifts?activity_id=${activity.id}`);
    const existingShifts = await shiftsRes.json();

    const grid = document.getElementById('grid-container');
    grid.innerHTML = '';

    for (let hour = 0; hour < 48; hour++) { // Beispiel: 48 Stunden
      const slot = document.createElement('div');
      slot.className = 'shift-slot';
      slot.dataset.hour = hour;

      const isAllowed = allowedBlocks.some(block => hour >= block.start && hour < block.end);
      const isExisting = existingShifts.some(shift => hour >= shift.start_time && hour < shift.end_time);

      if (isExisting) {
        slot.classList.add('existing');
        slot.textContent = `Schicht (${hour}:00)`;
      } else if (isAllowed) {
        slot.classList.add('allowed');
        slot.textContent = `Erlaubt (${hour}:00)`;
      } else {
        slot.classList.add('not-allowed');
        slot.textContent = `Nicht erlaubt (${hour}:00)`;
      }

      slot.addEventListener('click', () => toggleBlock(hour, activity));
      grid.appendChild(slot);
    }
  }

  // Umschalten eines Zeitblocks (erlaubt/nicht erlaubt)
  async function toggleBlock(hour, activity) {
    try {
      const res = await fetch(`${API_URL_HELFERPLAN}/activities/${activity.id}/allowed-time-blocks`);
      let allowedBlocks = await res.json();

      // Block hinzufügen oder entfernen
      const existingIndex = allowedBlocks.findIndex(block => hour >= block.start && hour < block.end);
      if (existingIndex >= 0) {
        allowedBlocks.splice(existingIndex, 1); // Entfernen
      } else {
        allowedBlocks.push({ start: hour, end: hour + 1 }); // Hinzufügen
      }

      // Aktualisiere die Datenbank
      await fetch(`${API_URL_HELFERPLAN}/activities/${activity.id}/allowed-time-blocks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ blocks: allowedBlocks })
      });

      // Raster neu rendern
      renderGrid(activity);
    } catch (error) {
      console.error('Fehler beim Umschalten des Blocks:', error);
      alert('Ein Fehler ist beim Speichern des Blocks aufgetreten.');
    }
  }

  // Initialisierung
  document.addEventListener('DOMContentLoaded', () => {
    loadActivities();
  });
</script>
</body>
</html>