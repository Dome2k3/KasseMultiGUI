<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Zeitblöcke verwalten</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    html, body { overflow-x: hidden; }
    .plan-main { max-width: 1200px; margin: 0 auto; }
    .plan-layout { display: flex; gap: 12px; align-items: flex-start; }
    .left-panel { width: 240px; flex: 0 0 240px; }

    #plan-container { overflow-x: auto; flex: 1 1 auto; position: relative; }
    #timeline-header { position: sticky; top: 0; background: #fff; z-index: 10; display:block; }

    /* wichtig: alle relevant boxen box-sizing border-box */
    #timeline-header, #grid-container, .hour-slot, .shift-slot, .activity-name { box-sizing: border-box; }

    .hour-slot { font-size:12px; padding:4px 6px; text-align:center; background:#fafafa; }
    .shift-slot { font-size:12px; padding:6px; min-height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; transition: transform .08s, outline .08s; }
    .shift-slot.filled { color:#fff; }

    .dimmed { opacity: .28; filter: grayscale(80%); }

    .shift-slot.potential-drop { outline:3px dashed rgba(33,150,243,0.9); transform: translateY(-1px); box-shadow:0 0 0 3px rgba(33,150,243,0.04) inset; }
    .shift-slot.drop-target { outline:3px solid rgba(33,150,243,0.95); transform: translateY(-2px); box-shadow:0 0 0 3px rgba(33,150,243,0.08) inset; }

    .slot-hidden { display:none !important; }

    /* die linke placeholder-zelle im header (falls sichtbar) auf transparent setzen */
    .left-placeholder { background: transparent !important; }

    /* Die linke Spalte (activity name) ist sticky, Teil des selben Grids */
    .activity-name {
      background: #fff;
      position: sticky;
      left: 0;
      z-index: 5;
      padding: 8px;
      border-right: 1px solid #e6e6e6;
      min-height: 36px;
      display:flex;
      align-items:center;
      font-weight:600;
    }

    .activity-group-header { padding:8px 0 4px 0; font-weight:700; grid-column:1 / -1; background: transparent; }
    #grid-container { overflow: visible; }
  </style>
</head>
<body>
<nav>
  <a href="index.html" class="active">Admin: Stammdaten</a>
  <a href="plan.html">Turnier-Planung</a>
  <a href="plan-admin.html">Turnier-Admin</a>
</nav>

<main class="plan-main">
  <h1>Admin: Zeitblöcke verwalten</h1>
  <div class="plan-layout">
    <div class="left-panel">
      <h3>Aktivitäten</h3>
      <div id="activity-list"></div>
    </div>

    <div id="plan-container">
      <div id="timeline-header" aria-hidden="true"></div>
      <div id="grid-container" role="grid"></div>
    </div>
  </div>
</main>

<script src="/helferplan/public/config.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const timelineHeader = document.getElementById('timeline-header');
    const gridContainer = document.getElementById('grid-container');

    let activities = [];
    let allowedBlocks = {};

    async function fetchActivities() {
      const res = await fetch(`${window.API_URL_HELFERPLAN}/activities`);
      activities = await res.json();
    }

    async function fetchAllowedBlocks() {
      for (const activity of activities) {
        const res = await fetch(`${window.API_URL_HELFERPLAN}/activities/${activity.id}/allowed-time-blocks`);
        allowedBlocks[activity.id] = await res.json();
      }
    }

    function renderTimeline() {
      timelineHeader.innerHTML = '';
      const totalHours = 48; // Beispiel für 2 Tage
      timelineHeader.style.gridTemplateColumns = `repeat(${totalHours}, 40px)`;

      for (let hour = 0; hour < totalHours; hour++) {
        const hourSlot = document.createElement('div');
        hourSlot.className = 'hour-slot';
        const time = `${12 + (hour % 24)}:00`; // Uhrzeit berechnen
        hourSlot.textContent = time;
        timelineHeader.appendChild(hourSlot);
      }
    }

    function renderGrid() {
      gridContainer.innerHTML = '';
      activities.forEach(activity => {
        const row = document.createElement('div');
        row.className = 'activity-row';
        row.style.display = 'grid';
        row.style.gridTemplateColumns = `200px repeat(48, 40px)`; // 200px für Aktivitätsnamen, 48 für Stunden

        const nameCell = document.createElement('div');
        nameCell.className = 'activity-name';
        nameCell.textContent = activity.name;
        row.appendChild(nameCell);

        for (let hour = 0; hour < 48; hour++) {
          const slot = document.createElement('div');
          slot.className = 'shift-slot';

          const isAllowed = allowedBlocks[activity.id]?.some(block => hour >= block.start && hour < block.end);
          slot.classList.add(isAllowed ? 'allowed' : 'not-allowed');

          slot.draggable = true;
          slot.addEventListener('dragstart', () => {
            slot.classList.add('hover');
          });
          slot.addEventListener('dragend', () => {
            slot.classList.remove('hover');
          });
          slot.addEventListener('drop', async (event) => {
            event.preventDefault();
            const updatedBlocks = allowedBlocks[activity.id] || [];
            const existingIndex = updatedBlocks.findIndex(block => hour >= block.start && hour < block.end);
            if (existingIndex >= 0) {
              updatedBlocks.splice(existingIndex, 1);
              slot.classList.remove('allowed');
              slot.classList.add('not-allowed');
            } else {
              updatedBlocks.push({ start: hour, end: hour + 1 });
              slot.classList.remove('not-allowed');
              slot.classList.add('allowed');
            }
            await fetch(`${window.API_URL_HELFERPLAN}/activities/${activity.id}/allowed-time-blocks`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ blocks: updatedBlocks })
            });
            allowedBlocks[activity.id] = updatedBlocks;
          });

          row.appendChild(slot);
        }

        gridContainer.appendChild(row);
      });
    }

    await fetchActivities();
    await fetchAllowedBlocks();
    renderTimeline();
    renderGrid();
  });
</script>
</body>
</html>