<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auf- und Abbau Planung</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .filter-panel {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-panel label {
            font-weight: 600;
            margin-right: 8px;
        }
        .filter-panel select {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .setup-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }
        .day-wrapper {
            display: flex;
            flex-direction: column;
            border: 2px solid #005A9F;
            padding: 12px;
            border-radius: 8px;
            background: #f0f8ff;
        }
        .day-wrapper.abbau {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        .day-wrapper-shifts {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        .shift-column {
            flex: 0 0 100px;
            min-width: 100px;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 6px;
            background: #fff;
        }
        .shift-column h4 {
            margin: 0 0 8px 0;
            color: #005A9F;
            font-size: 13px;
            text-align: center;
            border-bottom: 1px solid #005A9F;
            padding-bottom: 4px;
        }
        .shift-time {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .shifts-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .shift-row {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 3px 5px;
            font-size: 10px;
        }
        .shift-row.required {
            border-color: #ff9800;
            background-color: #fff3e0;
        }
        .shift-number {
            font-weight: 600;
            color: #666;
            min-width: 18px;
            font-size: 10px;
        }
        .helper-select {
            flex: 1;
            max-width: 100px;
            padding: 3px 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 10px;
        }
        .helper-name {
            flex: 1;
            padding: 2px 3px;
            border-radius: 3px;
            color: #fff;
            font-weight: 600;
            text-align: center;
            min-height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .info-text {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-bottom: 12px;
        }
        .dimmed {
            opacity: 0.3;
            filter: grayscale(80%);
        }
        .day-header {
            font-size: 16px;
            font-weight: 700;
            color: #005A9F;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #005A9F;
        }
    </style>
</head>
<body>
<nav>
    <a href="index.html">Admin: Stammdaten</a>
    <a href="plan.html">Turnier-Planung</a>
    <a href="plan-admin.html">Turnier-Admin</a>
    <a href="aufbau-abbau.html" class="active">Auf-/Abbau</a>
    <a href="kuchen.html">Kuchen</a>
</nav>

<main>
    <h1>Auf- und Abbau Planung</h1>
    <p class="info-text">Jeder Auf-/Abbautag wird in 4-Stunden-Schichten unterteilt. Jedem Schichtblock können bis zu 40 Helfer zugewiesen werden. Die ersten Slots (orange markiert) sind für Erwachsene/Orga-Helfer reserviert.</p>
    
    <div class="filter-panel">
        <div>
            <label for="view-team-filter">Team-Ansicht filtern:</label>
            <select id="view-team-filter">
                <option value="">Alle Teams</option>
            </select>
        </div>
        <div>
            <label for="helper-team-filter">Helfer-Auswahl filtern:</label>
            <select id="helper-team-filter">
                <option value="">Alle Teams</option>
            </select>
        </div>
    </div>
    
    <div id="setup-container" class="setup-container">
        <!-- Days and shift columns will be generated dynamically -->
    </div>
</main>

<!-- Lade runtime config vor den App-Skripten -->
<script src="/helferplan/public/config.js"></script>
<script src="/helferplan/public/js/utils.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // API URL setup (same pattern as plan.js)
    const API_URL = (() => {
        const meta = document.querySelector('meta[name="api-url-helferplan"]');
        if (meta && meta.content) return meta.content.replace(/\/$/, '');
        if (window.__API_URL_HELFERPLAN) return String(window.__API_URL_HELFERPLAN).replace(/\/$/, '');
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            return `${window.location.protocol}//${window.location.hostname}:3003/api`;
        }
        return `${window.location.origin}/api`;
    })();
    
    const container = document.getElementById('setup-container');
    const viewTeamFilter = document.getElementById('view-team-filter');
    const helperTeamFilter = document.getElementById('helper-team-filter');
    
    let helpers = [];
    let teams = [];
    let shifts = [];
    let settings = {};
    let helperById = {};
    
    // Fetch all required data
    async function loadData() {
        try {
            const [helpersRes, teamsRes, settingsRes, shiftsRes] = await Promise.all([
                fetch(`${API_URL}/helpers`),
                fetch(`${API_URL}/teams`),
                fetch(`${API_URL}/settings`),
                fetch(`${API_URL}/setup-cleanup-shifts`)
            ]);
            
            helpers = await helpersRes.json();
            teams = await teamsRes.json();
            settings = await settingsRes.json();
            shifts = await shiftsRes.json();
            
            // Build helper lookup
            helperById = {};
            helpers.forEach(h => helperById[h.id] = h);
            
            // Populate filter dropdowns
            populateTeamFilters();
        } catch (err) {
            console.error('Error loading data:', err);
            alert('Fehler beim Laden der Daten');
        }
    }
    
    function populateTeamFilters() {
        viewTeamFilter.innerHTML = '<option value="">Alle Teams</option>';
        helperTeamFilter.innerHTML = '<option value="">Alle Teams</option>';
        teams.forEach(team => {
            viewTeamFilter.add(new Option(team.name, team.id));
            helperTeamFilter.add(new Option(team.name, team.id));
        });
    }
    
    function getTeamColor(teamId) {
        const team = teams.find(t => t.id === teamId);
        return team ? team.color_hex : '#999';
    }
    
    // Note: parseTime, formatTime, and hexToRgb are now in utils.js
    
    function renderDays() {
        container.innerHTML = '';
        
        const daysData = [];
        
        // Process setup days (1-3)
        for (let i = 1; i <= 3; i++) {
            const dateKey = `setup_day_${i}`;
            const startKey = `setup_day_${i}_start`;
            const endKey = `setup_day_${i}_end`;
            const minKey = `setup_day_${i}_min`;
            
            const date = settings[dateKey];
            const startTime = settings[startKey] || '08:00';
            const endTime = settings[endKey] || '20:00';
            const minHelpers = parseInt(settings[minKey] || 10);
            
            if (date) {
                daysData.push({ 
                    type: 'Aufbau', 
                    date, 
                    startTime, 
                    endTime, 
                    minHelpers, 
                    dayNumber: i 
                });
            }
        }
        
        // Process teardown day
        const teardownDate = settings.teardown_day_1;
        const teardownStart = settings.teardown_day_1_start || '08:00';
        const teardownEnd = settings.teardown_day_1_end || '20:00';
        const teardownMin = parseInt(settings.teardown_day_1_min || 10);
        
        if (teardownDate) {
            daysData.push({ 
                type: 'Abbau', 
                date: teardownDate, 
                startTime: teardownStart, 
                endTime: teardownEnd, 
                minHelpers: teardownMin, 
                dayNumber: 1 
            });
        }
        
        // Render all days
        daysData.forEach(dayData => renderDayWithShifts(dayData));
        
        // Apply view filter after rendering
        applyViewFilter();
    }
    
    function renderDayWithShifts(dayData) {
        const { type, date, startTime, endTime, minHelpers, dayNumber } = dayData;
        
        // Calculate shift blocks (4 hours each)
        const startHours = parseTime(startTime);
        const endHours = parseTime(endTime);
        const totalHours = endHours - startHours;
        
        // Create 4-hour shifts
        const shiftBlocks = [];
        let currentStart = startHours;
        
        while (currentStart < endHours) {
            const shiftEnd = Math.min(currentStart + 4, endHours);
            shiftBlocks.push({
                start: currentStart,
                end: shiftEnd,
                duration: shiftEnd - currentStart
            });
            currentStart = shiftEnd;
        }
        
        // Create day wrapper
        const d = new Date(date + 'T00:00:00');
        const weekday = d.toLocaleDateString('de-DE', { weekday: 'long' });
        const dateStr = d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
        
        const dayWrapper = document.createElement('div');
        dayWrapper.className = 'day-wrapper';
        if (type === 'Abbau') {
            dayWrapper.classList.add('abbau');
        }
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header';
        dayHeader.textContent = `${weekday} ${dateStr} - ${type}${type === 'Aufbau' ? ' Tag ' + dayNumber : ''}`;
        dayWrapper.appendChild(dayHeader);
        
        // Create container for shift columns
        const shiftsContainer = document.createElement('div');
        shiftsContainer.className = 'day-wrapper-shifts';
        
        // Create shift columns
        shiftBlocks.forEach((block, blockIndex) => {
            const column = renderShiftColumn(dayData, block, blockIndex);
            shiftsContainer.appendChild(column);
        });
        
        dayWrapper.appendChild(shiftsContainer);
        container.appendChild(dayWrapper);
    }
    
    function renderShiftColumn(dayData, shiftBlock, blockIndex) {
        const { type, date, minHelpers } = dayData;
        const { start, end, duration } = shiftBlock;
        
        const startStr = formatTime(start);
        const endStr = formatTime(end);
        
        // Count filled slots for this shift block
        const blockShifts = shifts.filter(s => {
            if (s.day_type !== type) return false;
            const shiftDate = s.start_time ? s.start_time.substring(0, 10) : '';
            if (shiftDate !== date) return false;
            
            // Check if this shift belongs to this block (using hour as identifier)
            const shiftTime = new Date(s.start_time);
            const shiftHour = shiftTime.getUTCHours() + shiftTime.getUTCMinutes() / 60;
            return Math.abs(shiftHour - start) < 0.1 && s.helper_id;
        });
        const filledCount = blockShifts.length;
        
        const column = document.createElement('div');
        column.className = 'shift-column';
        
        const header = document.createElement('h4');
        header.textContent = `${startStr} - ${endStr}`;
        column.appendChild(header);
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'shift-time';
        timeDiv.textContent = `${filledCount} / 40`;
        column.appendChild(timeDiv);
        
        const shiftsList = document.createElement('div');
        shiftsList.className = 'shifts-list';
        
        // Create 40 shift rows for this block
        for (let i = 0; i < 40; i++) {
            const row = createShiftRow(type, date, start, i, minHelpers);
            shiftsList.appendChild(row);
        }
        
        column.appendChild(shiftsList);
        return column;
    }
    
    function createShiftRow(type, date, shiftStartHour, slotIndex, minHelpers) {
        const row = document.createElement('div');
        row.className = 'shift-row';
        row.dataset.date = date;
        row.dataset.type = type;
        row.dataset.shiftHour = shiftStartHour;
        row.dataset.slotIndex = slotIndex;
        
        // Mark first minHelpers slots as required (Erwachsen/Orga only)
        if (slotIndex < minHelpers) {
            row.classList.add('required');
        }
        
        // Find existing shift for this slot
        const existingShift = shifts.find(s => {
            if (s.day_type !== type) return false;
            const shiftDate = s.start_time ? s.start_time.substring(0, 10) : '';
            if (shiftDate !== date) return false;
            
            // Match by hour and slot index (minutes)
            const startTime = new Date(s.start_time);
            const hour = startTime.getUTCHours();
            const minutes = startTime.getUTCMinutes();
            
            // Calculate expected hour and minutes for this slot
            const expectedStartHours = Math.floor(shiftStartHour);
            const expectedStartMinutes = Math.round((shiftStartHour - expectedStartHours) * 60);
            const totalExpectedMinutes = expectedStartMinutes + slotIndex;
            const expectedHour = expectedStartHours + Math.floor(totalExpectedMinutes / 60);
            const expectedMinute = totalExpectedMinutes % 60;
            
            return hour === expectedHour && minutes === expectedMinute;
        });
        
        const shiftNumber = document.createElement('div');
        shiftNumber.className = 'shift-number';
        shiftNumber.textContent = `${slotIndex + 1}.`;
        row.appendChild(shiftNumber);
        
        if (existingShift && existingShift.helper_id) {
            // Show helper name with team color
            const helper = helperById[existingShift.helper_id];
            if (helper) {
                const helperName = document.createElement('div');
                helperName.className = 'helper-name';
                const teamColor = getTeamColor(helper.team_id);
                helperName.style.backgroundColor = teamColor;
                helperName.style.color = getTextColorForBackground(teamColor);
                helperName.textContent = helper.name;
                helperName.dataset.helperId = helper.id;
                helperName.dataset.teamId = helper.team_id;
                helperName.title = `Klicken zum Ändern/Entfernen`;
                helperName.style.cursor = 'pointer';
                helperName.addEventListener('click', () => {
                    // Clear the shift and show dropdown
                    row.removeChild(helperName);
                    const select = createHelperSelect(type, date, shiftStartHour, slotIndex, minHelpers, null);
                    row.appendChild(select);
                    saveShift(date, type, shiftStartHour, slotIndex, null);
                });
                row.appendChild(helperName);
            }
        } else {
            // Show dropdown
            const select = createHelperSelect(type, date, shiftStartHour, slotIndex, minHelpers, null);
            row.appendChild(select);
        }
        
        return row;
    }
    
    function createHelperSelect(type, date, shiftStartHour, slotIndex, minHelpers, selectedHelperId) {
        const select = document.createElement('select');
        select.className = 'helper-select';
        select.dataset.date = date;
        select.dataset.type = type;
        select.dataset.shiftHour = shiftStartHour;
        select.dataset.slotIndex = slotIndex;
        
        // Get filter value
        const filterTeamId = helperTeamFilter.value;
        
        // Filter helpers based on requirements and team filter
        let filteredHelpers = helpers;
        
        // Filter by role if required slot
        if (slotIndex < minHelpers) {
            filteredHelpers = filteredHelpers.filter(h => h.role === 'Erwachsen' || h.role === 'Orga');
        }
        
        // Filter by team if filter is set
        if (filterTeamId) {
            filteredHelpers = filteredHelpers.filter(h => String(h.team_id) === String(filterTeamId));
        }
        
        // Build options
        select.innerHTML = '<option value="">- Helfer -</option>';
        filteredHelpers.forEach(h => {
            const option = document.createElement('option');
            option.value = h.id;
            option.textContent = h.name; // Only show name, not team
            if (selectedHelperId && h.id == selectedHelperId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Add change listener
        select.addEventListener('change', async (e) => {
            await saveShift(date, type, shiftStartHour, slotIndex, e.target.value);
        });
        
        return select;
    }
    
    async function saveShift(date, dayType, shiftStartHour, slotIndex, helperId) {
        try {
            // Calculate start and end times with unique minutes for each slot
            const startHours = Math.floor(shiftStartHour);
            const startMinutes = Math.round((shiftStartHour - startHours) * 60);
            
            const baseDate = new Date(date + 'T00:00:00Z');
            baseDate.setUTCHours(startHours);
            baseDate.setUTCMinutes(startMinutes + slotIndex); // Use slotIndex as minute offset
            const startTime = baseDate.toISOString();
            
            const endDate = new Date(baseDate);
            endDate.setUTCHours(endDate.getUTCHours() + 4); // 4 hour shift
            const endTime = endDate.toISOString();
            
            const payload = {
                day_type: dayType,
                start_time: startTime,
                end_time: endTime,
                helper_id: helperId || null
            };
            
            const response = await fetch(`${API_URL}/setup-cleanup-shifts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) throw new Error('Speichern fehlgeschlagen');
            
            // Reload shifts and re-render
            const shiftsRes = await fetch(`${API_URL}/setup-cleanup-shifts`);
            shifts = await shiftsRes.json();
            renderDays();
        } catch (err) {
            console.error('Error saving shift:', err);
            alert('Fehler beim Speichern der Schicht');
        }
    }
    
    function applyViewFilter() {
        const viewTeamId = viewTeamFilter.value;
        
        // Get all helper name elements
        const helperNames = document.querySelectorAll('.helper-name');
        
        if (!viewTeamId) {
            // Show all
            helperNames.forEach(el => el.classList.remove('dimmed'));
        } else {
            // Dim those not matching the filter
            helperNames.forEach(el => {
                const teamId = el.dataset.teamId;
                if (String(teamId) === String(viewTeamId)) {
                    el.classList.remove('dimmed');
                } else {
                    el.classList.add('dimmed');
                }
            });
        }
    }
    
    // Event listeners for filters
    viewTeamFilter.addEventListener('change', applyViewFilter);
    helperTeamFilter.addEventListener('change', renderDays);
    
    // Initial load
    await loadData();
    renderDays();
});
</script>
</body>
</html>
