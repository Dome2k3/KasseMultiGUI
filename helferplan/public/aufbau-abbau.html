<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auf- und Abbau Planung</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .filter-panel {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-panel label {
            font-weight: 600;
            margin-right: 8px;
        }
        .filter-panel select {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .setup-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            overflow-x: auto;
        }
        .day-column {
            flex: 0 0 280px;
            min-width: 280px;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .day-column h3 {
            margin-top: 0;
            color: #005A9F;
            border-bottom: 2px solid #005A9F;
            padding-bottom: 8px;
            font-size: 16px;
            text-align: center;
        }
        .shifts-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 12px;
        }
        .shift-row {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }
        .shift-row.required {
            border-color: #ff9800;
            background-color: #fff3e0;
        }
        .shift-number {
            font-weight: 600;
            color: #666;
            min-width: 25px;
        }
        .helper-select {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 11px;
        }
        .helper-name {
            flex: 1;
            padding: 4px 8px;
            border-radius: 4px;
            color: #fff;
            font-weight: 600;
            text-align: center;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .info-text {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-bottom: 12px;
        }
        .dimmed {
            opacity: 0.3;
            filter: grayscale(80%);
        }
    </style>
</head>
<body>
<nav>
    <a href="index.html">Admin: Stammdaten</a>
    <a href="plan.html">Turnier-Planung</a>
    <a href="plan-admin.html">Turnier-Admin</a>
    <a href="aufbau-abbau.html" class="active">Auf-/Abbau</a>
    <a href="kuchen.html">Kuchen</a>
</nav>

<main>
    <h1>Auf- und Abbau Planung</h1>
    <p class="info-text">Jedem Auf-/Abbautag können bis zu 40 Helfer zugewiesen werden (4-Stunden-Schichten). Die ersten Slots (orange markiert) sind für Erwachsene/Orga-Helfer reserviert.</p>
    
    <div class="filter-panel">
        <div>
            <label for="view-team-filter">Team-Ansicht filtern:</label>
            <select id="view-team-filter">
                <option value="">Alle Teams</option>
            </select>
        </div>
        <div>
            <label for="helper-team-filter">Helfer-Auswahl filtern:</label>
            <select id="helper-team-filter">
                <option value="">Alle Teams</option>
            </select>
        </div>
    </div>
    
    <div id="setup-container" class="setup-container">
        <!-- Days will be generated dynamically -->
    </div>
</main>

<!-- Lade runtime config vor den App-Skripten -->
<script src="/helferplan/public/config.js"></script>
<script src="/helferplan/public/js/utils.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // API URL setup (same pattern as plan.js)
    const API_URL = (() => {
        const meta = document.querySelector('meta[name="api-url-helferplan"]');
        if (meta && meta.content) return meta.content.replace(/\/$/, '');
        if (window.__API_URL_HELFERPLAN) return String(window.__API_URL_HELFERPLAN).replace(/\/$/, '');
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            return `${window.location.protocol}//${window.location.hostname}:3003/api`;
        }
        return `${window.location.origin}/api`;
    })();
    
    const container = document.getElementById('setup-container');
    const viewTeamFilter = document.getElementById('view-team-filter');
    const helperTeamFilter = document.getElementById('helper-team-filter');
    
    let helpers = [];
    let teams = [];
    let shifts = [];
    let settings = {};
    let helperById = {};
    
    // Fetch all required data
    async function loadData() {
        try {
            const [helpersRes, teamsRes, settingsRes, shiftsRes] = await Promise.all([
                fetch(`${API_URL}/helpers`),
                fetch(`${API_URL}/teams`),
                fetch(`${API_URL}/settings`),
                fetch(`${API_URL}/setup-cleanup-shifts`)
            ]);
            
            helpers = await helpersRes.json();
            teams = await teamsRes.json();
            settings = await settingsRes.json();
            shifts = await shiftsRes.json();
            
            // Build helper lookup
            helperById = {};
            helpers.forEach(h => helperById[h.id] = h);
            
            // Populate filter dropdowns
            populateTeamFilters();
        } catch (err) {
            console.error('Error loading data:', err);
            alert('Fehler beim Laden der Daten');
        }
    }
    
    function populateTeamFilters() {
        viewTeamFilter.innerHTML = '<option value="">Alle Teams</option>';
        helperTeamFilter.innerHTML = '<option value="">Alle Teams</option>';
        teams.forEach(team => {
            viewTeamFilter.add(new Option(team.name, team.id));
            helperTeamFilter.add(new Option(team.name, team.id));
        });
    }
    
    function getTeamColor(teamId) {
        const team = teams.find(t => t.id === teamId);
        return team ? team.color_hex : '#999';
    }
    
    function renderDays() {
        container.innerHTML = '';
        
        const daysData = [];
        
        // Process setup days (1-3)
        for (let i = 1; i <= 3; i++) {
            const dateKey = `setup_day_${i}`;
            const minKey = `setup_day_${i}_min`;
            const date = settings[dateKey];
            const minHelpers = parseInt(settings[minKey] || 10);
            
            if (date) {
                daysData.push({ type: 'Aufbau', date, minHelpers, dayNumber: i });
            }
        }
        
        // Process teardown day
        const teardownDate = settings.teardown_day_1;
        const teardownMin = parseInt(settings.teardown_day_1_min || 10);
        if (teardownDate) {
            daysData.push({ type: 'Abbau', date: teardownDate, minHelpers: teardownMin, dayNumber: 1 });
        }
        
        // Render all days as columns
        daysData.forEach(dayData => renderDayColumn(dayData));
        
        // Apply view filter after rendering
        applyViewFilter();
    }
    
    function renderDayColumn(dayData) {
        const { type, date, minHelpers, dayNumber } = dayData;
        const d = new Date(date + 'T00:00:00');
        const weekday = d.toLocaleDateString('de-DE', { weekday: 'long' });
        const dateStr = d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
        
        // Count filled slots for this day
        const dayShifts = shifts.filter(s => {
            if (s.day_type !== type) return false;
            const shiftDate = s.start_time ? s.start_time.substring(0, 10) : '';
            return shiftDate === date && s.helper_id;
        });
        const filledCount = dayShifts.length;
        
        const column = document.createElement('div');
        column.className = 'day-column';
        column.innerHTML = `<h3>${weekday} ${dateStr}<br/>${type}${type === 'Aufbau' ? ' Tag ' + dayNumber : ''}<br/>(${filledCount} / 40)</h3>`;
        
        const shiftsList = document.createElement('div');
        shiftsList.className = 'shifts-list';
        
        // Create 40 shift rows
        for (let i = 0; i < 40; i++) {
            const row = createShiftRow(type, date, i, minHelpers);
            shiftsList.appendChild(row);
        }
        
        column.appendChild(shiftsList);
        container.appendChild(column);
    }
    
    function createShiftRow(type, date, slotIndex, minHelpers) {
        const row = document.createElement('div');
        row.className = 'shift-row';
        row.dataset.date = date;
        row.dataset.type = type;
        row.dataset.slotIndex = slotIndex;
        
        // Mark first minHelpers slots as required (Erwachsen/Orga only)
        if (slotIndex < minHelpers) {
            row.classList.add('required');
        }
        
        // Find existing shift for this slot
        const existingShift = shifts.find(s => {
            if (s.day_type !== type) return false;
            const shiftDate = s.start_time ? s.start_time.substring(0, 10) : '';
            if (shiftDate !== date) return false;
            const startTime = new Date(s.start_time);
            return startTime.getMinutes() === slotIndex;
        });
        
        const shiftNumber = document.createElement('div');
        shiftNumber.className = 'shift-number';
        shiftNumber.textContent = `${slotIndex + 1}.`;
        row.appendChild(shiftNumber);
        
        if (existingShift && existingShift.helper_id) {
            // Show helper name with team color
            const helper = helperById[existingShift.helper_id];
            if (helper) {
                const helperName = document.createElement('div');
                helperName.className = 'helper-name';
                const teamColor = getTeamColor(helper.team_id);
                helperName.style.backgroundColor = teamColor;
                helperName.style.color = getTextColorForBackground(teamColor);
                helperName.textContent = helper.name;
                helperName.dataset.helperId = helper.id;
                helperName.dataset.teamId = helper.team_id;
                helperName.title = `Klicken zum Ändern/Entfernen`;
                helperName.style.cursor = 'pointer';
                helperName.addEventListener('click', () => {
                    // Clear the shift and show dropdown
                    row.removeChild(helperName);
                    const select = createHelperSelect(type, date, slotIndex, minHelpers, null);
                    row.appendChild(select);
                    saveShift(date, type, slotIndex, null);
                });
                row.appendChild(helperName);
            }
        } else {
            // Show dropdown
            const select = createHelperSelect(type, date, slotIndex, minHelpers, null);
            row.appendChild(select);
        }
        
        return row;
    }
    
    function createHelperSelect(type, date, slotIndex, minHelpers, selectedHelperId) {
        const select = document.createElement('select');
        select.className = 'helper-select';
        select.dataset.date = date;
        select.dataset.type = type;
        select.dataset.slotIndex = slotIndex;
        
        // Get filter value
        const filterTeamId = helperTeamFilter.value;
        
        // Filter helpers based on requirements and team filter
        let filteredHelpers = helpers;
        
        // Filter by role if required slot
        if (slotIndex < minHelpers) {
            filteredHelpers = filteredHelpers.filter(h => h.role === 'Erwachsen' || h.role === 'Orga');
        }
        
        // Filter by team if filter is set
        if (filterTeamId) {
            filteredHelpers = filteredHelpers.filter(h => String(h.team_id) === String(filterTeamId));
        }
        
        // Build options
        select.innerHTML = '<option value="">-- Helfer wählen --</option>';
        filteredHelpers.forEach(h => {
            const option = document.createElement('option');
            option.value = h.id;
            option.textContent = `${h.name}${h.team_name ? ' - ' + h.team_name : ''}`;
            if (selectedHelperId && h.id == selectedHelperId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Add change listener
        select.addEventListener('change', async (e) => {
            await saveShift(date, type, slotIndex, e.target.value);
        });
        
        return select;
    }
    
    async function saveShift(date, dayType, slotIndex, helperId) {
        try {
            // Calculate start and end times with unique minutes for each slot
            const baseDate = new Date(date + 'T08:00:00Z');
            baseDate.setMinutes(baseDate.getMinutes() + slotIndex);
            const startTime = baseDate.toISOString();
            
            const endDate = new Date(baseDate);
            endDate.setHours(endDate.getHours() + 4); // 4 hour shift
            const endTime = endDate.toISOString();
            
            const payload = {
                day_type: dayType,
                start_time: startTime,
                end_time: endTime,
                helper_id: helperId || null
            };
            
            const response = await fetch(`${API_URL}/setup-cleanup-shifts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) throw new Error('Speichern fehlgeschlagen');
            
            // Reload shifts and re-render
            const shiftsRes = await fetch(`${API_URL}/setup-cleanup-shifts`);
            shifts = await shiftsRes.json();
            renderDays();
        } catch (err) {
            console.error('Error saving shift:', err);
            alert('Fehler beim Speichern der Schicht');
        }
    }
    
    function applyViewFilter() {
        const viewTeamId = viewTeamFilter.value;
        
        // Get all helper name elements
        const helperNames = document.querySelectorAll('.helper-name');
        
        if (!viewTeamId) {
            // Show all
            helperNames.forEach(el => el.classList.remove('dimmed'));
        } else {
            // Dim those not matching the filter
            helperNames.forEach(el => {
                const teamId = el.dataset.teamId;
                if (String(teamId) === String(viewTeamId)) {
                    el.classList.remove('dimmed');
                } else {
                    el.classList.add('dimmed');
                }
            });
        }
    }
    
    // Event listeners for filters
    viewTeamFilter.addEventListener('change', applyViewFilter);
    helperTeamFilter.addEventListener('change', renderDays);
    
    // Initial load
    await loadData();
    renderDays();
});
</script>
</body>
</html>
