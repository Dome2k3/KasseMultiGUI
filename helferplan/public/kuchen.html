<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuchen-Spenden Planung</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .filter-panel {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-panel label {
            font-weight: 600;
            margin-right: 8px;
        }
        .filter-panel select {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .cakes-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            overflow-x: auto;
        }
        .day-column {
            flex: 0 0 320px;
            min-width: 320px;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .day-column h3 {
            margin-top: 0;
            color: #005A9F;
            border-bottom: 2px solid #005A9F;
            padding-bottom: 8px;
            text-align: center;
            font-size: 16px;
        }
        .cake-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }
        .cake-row {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 6px;
            font-size: 12px;
        }
        .cake-number {
            font-weight: 600;
            color: #666;
            margin-bottom: 4px;
        }
        .cake-helper-row {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }
        .helper-select {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 11px;
        }
        .helper-name {
            flex: 1;
            padding: 4px 8px;
            border-radius: 4px;
            color: #fff;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
        }
        .cake-details-row {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .cake-type-input {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 11px;
        }
        .nuts-checkbox-label {
            display: flex;
            align-items: center;
            font-size: 11px;
            white-space: nowrap;
        }
        .nuts-checkbox {
            margin-right: 4px;
        }
        .info-text {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-bottom: 12px;
        }
        .dimmed {
            opacity: 0.3;
            filter: grayscale(80%);
        }
    </style>
</head>
<body>
<nav>
    <a href="index.html">Admin: Stammdaten</a>
    <a href="plan.html">Turnier-Planung</a>
    <a href="plan-admin.html">Turnier-Admin</a>
    <a href="aufbau-abbau.html">Auf-/Abbau</a>
    <a href="kuchen.html" class="active">Kuchen</a>
</nav>

<main>
    <h1>Kuchen-Spenden Planung</h1>
    <p class="info-text">Tragen Sie hier ein, welche Helfer an welchem Tag einen Kuchen spenden. Die Anzahl der ben√∂tigten Kuchen pro Tag wird in den Admin-Einstellungen festgelegt.</p>
    
    <div class="filter-panel">
        <div>
            <label for="view-team-filter">Team-Ansicht filtern:</label>
            <select id="view-team-filter">
                <option value="">Alle Teams</option>
            </select>
        </div>
        <div>
            <label for="helper-team-filter">Helfer-Auswahl filtern:</label>
            <select id="helper-team-filter">
                <option value="">Alle Teams</option>
            </select>
        </div>
    </div>
    
    <div id="cakes-container" class="cakes-container">
        <!-- Day columns will be generated dynamically -->
    </div>
</main>

<!-- Lade runtime config vor den App-Skripten -->
<script src="/helferplan/public/config.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // API URL setup (same pattern as plan.js)
    const API_URL = (() => {
        const meta = document.querySelector('meta[name="api-url-helferplan"]');
        if (meta && meta.content) return meta.content.replace(/\/$/, '');
        if (window.__API_URL_HELFERPLAN) return String(window.__API_URL_HELFERPLAN).replace(/\/$/, '');
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            return `${window.location.protocol}//${window.location.hostname}:3003/api`;
        }
        return `${window.location.origin}/api`;
    })();
    
    const container = document.getElementById('cakes-container');
    const viewTeamFilter = document.getElementById('view-team-filter');
    const helperTeamFilter = document.getElementById('helper-team-filter');
    
    let helpers = [];
    let teams = [];
    let cakes = [];
    let settings = {};
    let helperById = {};
    
    // Fetch all required data
    async function loadData() {
        try {
            const [helpersRes, teamsRes, settingsRes, cakesRes] = await Promise.all([
                fetch(`${API_URL}/helpers`),
                fetch(`${API_URL}/teams`),
                fetch(`${API_URL}/settings`),
                fetch(`${API_URL}/cakes`)
            ]);
            
            helpers = await helpersRes.json();
            teams = await teamsRes.json();
            settings = await settingsRes.json();
            cakes = await cakesRes.json();
            
            // Build helper lookup
            helperById = {};
            helpers.forEach(h => helperById[h.id] = h);
            
            // Populate filter dropdowns
            populateTeamFilters();
        } catch (err) {
            console.error('Error loading data:', err);
            alert('Fehler beim Laden der Daten');
        }
    }
    
    function populateTeamFilters() {
        viewTeamFilter.innerHTML = '<option value="">Alle Teams</option>';
        helperTeamFilter.innerHTML = '<option value="">Alle Teams</option>';
        teams.forEach(team => {
            viewTeamFilter.add(new Option(team.name, team.id));
            helperTeamFilter.add(new Option(team.name, team.id));
        });
    }
    
    function getTeamColor(teamId) {
        const team = teams.find(t => t.id === teamId);
        return team ? team.color_hex : '#999';
    }
    
    function luminanceForHex(hex) {
        try {
            const c = hex.replace('#','');
            const r = parseInt(c.slice(0,2),16);
            const g = parseInt(c.slice(2,4),16);
            const b = parseInt(c.slice(4,6),16);
            return (0.299*r + 0.587*g + 0.114*b);
        } catch (e) { return 0; }
    }
    
    function renderDays() {
        container.innerHTML = '';
        
        const days = ['Freitag', 'Samstag', 'Sonntag'];
        const settingsKeys = ['cakes_friday', 'cakes_saturday', 'cakes_sunday'];
        
        days.forEach((day, idx) => {
            const count = parseInt(settings[settingsKeys[idx]] || 0);
            if (count > 0) {
                renderDayColumn(day, count);
            }
        });
        
        // Apply view filter after rendering
        applyViewFilter();
    }
    
    function renderDayColumn(day, count) {
        // Get existing cakes for this day
        const dayCakes = cakes.filter(c => c.donation_day === day);
        const filledCount = dayCakes.filter(c => c.helper_id).length;
        
        const column = document.createElement('div');
        column.className = 'day-column';
        column.innerHTML = `<h3>${day}<br/>(${filledCount} / ${count})</h3>`;
        
        const cakeList = document.createElement('div');
        cakeList.className = 'cake-list';
        
        // Create rows for the specified count
        for (let i = 0; i < count; i++) {
            const existingCake = dayCakes[i] || null;
            const row = createCakeRow(day, i + 1, existingCake);
            cakeList.appendChild(row);
        }
        
        column.appendChild(cakeList);
        container.appendChild(column);
    }
    
    function createCakeRow(day, rowNumber, existingCake) {
        const row = document.createElement('div');
        row.className = 'cake-row';
        row.dataset.day = day;
        row.dataset.rowNumber = rowNumber;
        
        const cakeId = existingCake ? existingCake.id : null;
        const helperId = existingCake ? existingCake.helper_id : null;
        const cakeType = existingCake ? existingCake.cake_type : '';
        const containsNuts = existingCake ? existingCake.contains_nuts : 0;
        
        // Cake number
        const cakeNumber = document.createElement('div');
        cakeNumber.className = 'cake-number';
        cakeNumber.textContent = `${rowNumber}. Kuchen`;
        row.appendChild(cakeNumber);
        
        // Helper row
        const helperRow = document.createElement('div');
        helperRow.className = 'cake-helper-row';
        
        if (helperId) {
            const helper = helperById[helperId];
            if (helper) {
                const helperName = document.createElement('div');
                helperName.className = 'helper-name';
                const teamColor = getTeamColor(helper.team_id);
                helperName.style.backgroundColor = teamColor;
                helperName.style.color = luminanceForHex(teamColor) > 160 ? '#111' : '#fff';
                helperName.textContent = helper.name;
                helperName.dataset.helperId = helper.id;
                helperName.dataset.teamId = helper.team_id;
                helperName.title = 'Klicken zum √Ñndern';
                helperName.addEventListener('click', () => {
                    // Replace with dropdown
                    helperRow.innerHTML = '';
                    const select = createHelperSelect(day, cakeId, helperId);
                    helperRow.appendChild(select);
                });
                helperRow.appendChild(helperName);
            }
        } else {
            const select = createHelperSelect(day, cakeId, null);
            helperRow.appendChild(select);
        }
        
        row.appendChild(helperRow);
        
        // Cake details row (name + nuts checkbox in one line)
        const detailsRow = document.createElement('div');
        detailsRow.className = 'cake-details-row';
        
        const cakeTypeInput = document.createElement('input');
        cakeTypeInput.type = 'text';
        cakeTypeInput.className = 'cake-type-input';
        cakeTypeInput.placeholder = 'Kuchenname';
        cakeTypeInput.value = cakeType || '';
        cakeTypeInput.addEventListener('blur', () => {
            saveCake(day, cakeId, helperId, cakeTypeInput.value, nutsCheckbox.checked);
        });
        detailsRow.appendChild(cakeTypeInput);
        
        const nutsLabel = document.createElement('label');
        nutsLabel.className = 'nuts-checkbox-label';
        const nutsCheckbox = document.createElement('input');
        nutsCheckbox.type = 'checkbox';
        nutsCheckbox.className = 'nuts-checkbox';
        nutsCheckbox.checked = containsNuts ? true : false;
        nutsCheckbox.addEventListener('change', () => {
            saveCake(day, cakeId, helperId, cakeTypeInput.value, nutsCheckbox.checked);
        });
        nutsLabel.appendChild(nutsCheckbox);
        nutsLabel.appendChild(document.createTextNode('N√ºsse'));
        detailsRow.appendChild(nutsLabel);
        
        row.appendChild(detailsRow);
        
        return row;
    }
    
    function createHelperSelect(day, cakeId, selectedHelperId) {
        const select = document.createElement('select');
        select.className = 'helper-select';
        
        // Get filter value
        const filterTeamId = helperTeamFilter.value;
        
        // Filter helpers based on team filter
        let filteredHelpers = helpers;
        if (filterTeamId) {
            filteredHelpers = filteredHelpers.filter(h => String(h.team_id) === String(filterTeamId));
        }
        
        // Build options
        select.innerHTML = '<option value="">-- Helfer w√§hlen --</option>';
        filteredHelpers.forEach(h => {
            const option = document.createElement('option');
            option.value = h.id;
            option.textContent = `${h.name}${h.team_name ? ' - ' + h.team_name : ''}`;
            if (selectedHelperId && h.id == selectedHelperId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Add change listener
        select.addEventListener('change', async (e) => {
            const newHelperId = e.target.value;
            // Get current cake type and nuts value from the row
            const row = select.closest('.cake-row');
            const cakeTypeInput = row.querySelector('.cake-type-input');
            const nutsCheckbox = row.querySelector('.nuts-checkbox');
            await saveCake(day, cakeId, newHelperId, cakeTypeInput.value, nutsCheckbox.checked);
        });
        
        return select;
    }
    
    async function saveCake(day, cakeId, helperId, cakeType, containsNuts) {
        try {
            const payload = {
                donation_day: day,
                helper_id: helperId || null,
                cake_type: cakeType || null,
                contains_nuts: containsNuts ? 1 : 0
            };
            
            if (cakeId) {
                payload.id = cakeId;
            }
            
            const response = await fetch(`${API_URL}/cakes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) throw new Error('Speichern fehlgeschlagen');
            
            // Reload data and re-render
            const cakesRes = await fetch(`${API_URL}/cakes`);
            cakes = await cakesRes.json();
            renderDays();
        } catch (err) {
            console.error('Error saving cake:', err);
            alert('Fehler beim Speichern des Kuchens');
        }
    }
    
    function applyViewFilter() {
        const viewTeamId = viewTeamFilter.value;
        
        // Get all helper name elements
        const helperNames = document.querySelectorAll('.helper-name');
        
        if (!viewTeamId) {
            // Show all
            helperNames.forEach(el => el.classList.remove('dimmed'));
        } else {
            // Dim those not matching the filter
            helperNames.forEach(el => {
                const teamId = el.dataset.teamId;
                if (String(teamId) === String(viewTeamId)) {
                    el.classList.remove('dimmed');
                } else {
                    el.classList.add('dimmed');
                }
            });
        }
    }
    
    // Event listeners for filters
    viewTeamFilter.addEventListener('change', applyViewFilter);
    helperTeamFilter.addEventListener('change', renderDays);
    
    // Initial load
    await loadData();
    renderDays();
});
</script>
</body>
</html>
